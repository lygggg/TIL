[# virtual dom이 뭐가 좋은가? (feat.React fiber)](https://velog.io/@yesbb/virtual-dom%EC%9D%98-%EC%84%B1%EB%8A%A5%EC%9D%B4-%EB%8D%94-%EC%A2%8B%EC%9D%80%EC%9D%B4%EC%9C%A0)
- DOM은 문서 객체 모델이다. 브라우저는 HTML 문서를 불러오고, 문서를 읽기 쉽도록 노드로 이루어진 트리구조 형태의 객체로 변환한다. 그후 우리는 자바스크립트로 DOM을 조작하면서 사용자에게 페이지를 보여준다.

- Virtual DOM은 허상으로 메모리에 생성된 가상의 DOM이다. 먼저 real dom으로부터 virtual dom을 생성하고, 그후에 변화가 생기면 새로운 버전의 virtual dom을 만든다. 그후 diff algorithm으로 virtual dom을 비교한다. 그후 차이점을 real dom에 적용한다.

- 기존에는 dirty checking, 옵저버패턴을 사용해서 변경된 dom을 수정했다. 하지만 dirty checking은 변화가 없을때도 재귀적으로 노드를 탐색함으로써 불필요한 비용이 발생했고, 옵저버 패턴은 변화가 일어날때 마다 전체 화면을 리렌더링하는 방식였고, 이것마저 비효율적이였다.

- 그래서 전체를 리렌더링을 하는 비용보다 virtual dom이라는 객체를 생성하는 비용이 더 저렴하다는 것을 알고, 생성된 virtual dom을 비교해서 수정된 부분만 real dom에 적용하는 방식을 사용하기로했다.

- 리액트 프레그먼트 안에있는 태그들은 모두 React.createElement로 생성된다. 그후 객체로 반환된다.

- React fiber는 react v16.0에서 소개된 리액트의 new core 알고리즘이다. React fiber는 기존의 리액트 diff 알고리즘의 한계를 극복하기 위해서 나왔다. 기본적으로 virtual tree를 비교를 하려면 call stack에 쌓이면서 재귀적으로 내려가면서 비교한다. 자바스크립트에서 비동기 작업들은 event loop가 call stack이 비어있는 여부를 확인한 후에야 콜백 함수들을 call stack에 올려 놓고 실행한다. 하지만 웹의 크기가 커지면 커질수록 call stack에 쌓인 콜백함수들이 많아지게 되고, 그러면서 비동기작업(애니메이션, 이벤트, setTimeout)들이 더 늦게 실행되면서 프레임 드랍이 발생하게 된다. 여기서 필요한게 React fiber다.

- React fiber의 목적

- 작업을 멈추고, 나중에 다시 실행

- 작업에 우선순위 부여

- 메모라이즈를 통해 불필요한 작업 제거

- 필요없는 작업 제거

[React Fiber architecture](https://github.com/acdlite/react-fiber-architecture)
- React Fiber의 목적은 animation, layout,gesture와 같은 영역들에 있어서 React의 적합성을 확보하기 위함이다. 주요 주제는 점증적 렌더링으로, 렌더링 작업을 chunk 단위로 나눈뒤 여러 프레임에 수행하는 것을 의미한다. 이와 더불어 새로운 업데이트가 들어올 때 기존의 작업을 멈추거나, 정지하거나, 재사용하는 기능들을 포함한다. 이외에도 다른 종류의 업데이트에 우선순위를 부여하거나, 새로운 동시성 모드를 위한 초기 작업들이 포함된다.

- 애플리케이션이 매 변화가 있을 때마다 리렌더링 하는 것은 정말 작은 앱에서나 가능한 일이다. 실제 애플리케이션은 이럴 경우 퍼포먼스 상에서 금지될 정도로 무거운 작업이다. 하지만 리액트는 최적화를 통해서 리렌더링 속에 전체 앱을 렌더하면서도 동시에 굉장한 성능을 유지할 수 있다.

- Fiber의 주요 목표가 React로 하여금 스케쥴링에 있어 강점을 갖도록 하는 것이다. 특히 아래 항목들을 할 수 있어야 한다.

- 작업을 중단하고 나중에 다시 돌아올 수 있어야 한다.

- 다른 종류의 작업에 우선순위를 부여할 수 있어야 한다.

- 이전에 완료된 작업을 재사용할 수 있어야 한다.

- 더 이상 필요 없어지면 작업을 중단할 수 있어야 한다.

- 위 항목들 중 하나라도 할 수 있으려면, 우리는 작업을 유닛 단위로 나눌 수 있어야 한다. 어떤 의미에서 그것 자체가 곧 Fiber라 할 수 있다.

- React Fiber는 특별히 React component를 위한 스택의 재구현이다. 단일 fiber는 가상의 스택프레임이라 볼 수 있다.

- 스택을 재구현 하는 것의 장점은 스택 프레임을 메모리에 저장하고 원할 때 실행할 수 있다는 것이다. 이것은 스케쥴링 목표를 달성하기 위해 중요하고, 스케쥴링 이외에도, 스택 프레임을 수동으로 다룰 수 있는 것은 동시성이나 에러 범위와 같은 기능들을 사용할 수 있게 해준다.

- 구체적인 용어로 Fiber는 컴포넌트에 대한 입력과 출력에 대한 정보들을 가지고 있는 JavaScript 객체다.

- React 요소로부터 fiber가 생성될때 type, key는 복사되어 전달된다. 개념상으로 type은 실행이 스택 프레임에 의해 추적되는 함수이다. type과 함께 key는 fiber가 재사용될 수 있는지를 판별하기 위해 재조정 중에 사용된다.

- child와 sibling 이 필드들은 다른 fiber를 대상으로 하며, fiber의 재귀적 트리 구조를 가리킨다. 자식 fiber는 컴포넌트의 render 함수가 반환하는 값에 해당한다. 이것을 함수 유추로 돌아가서 설명하면 자식 fiber는 꼬리 호출 함수라 생각할 수 있다.

- fiber는 자체적으로 메모라이즈를 통해 불필요한 작업을 방지한다.

- fiber 작업 우선 순위를 나타내는 숫자필드가 존재한다. 그리고 스케쥴러는 다음 수행할 작업 단위를 찾기 위해 우선순위 필드를 사용한다.