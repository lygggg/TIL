### 목차
- 코드를 타임라인 다이어그램으로 그리는 방법을 배운다.
- 버그를 찾기 위해 타임라인 다이어그램 보는 법을 이해한다.
- 타임라인끼리 공유하는 자원을 줄여 코드 설계를 개선하는 방법을 배운다.

타임라인 다이어그램은 액션을 순서대로 나열한 것이다. 타임라인 다이어그램은 시간에 따른 액션 순서를 시각적으로 표시한 것이다. 다이어그램 옆으로 타임라인을 하나씩 추가하면서 각 액션이 서로 어떻게 상호작용하고 간섭하는지 확인할 수 있다.

### 두 가지 타임라인 다이어그램 기본 규칙
1. 액션은 순서대로 실행되거나 동시에 실행한다.
2. 순서대로 실행되는 액션은 같은 타임라인에서 하나가 끝나면 다른 하나가 실행된다.
3. 동시에 실행되는 액션은 여러 타임라인에서 나란히 실행된다.

### 액션 순서에 관한 두가지 사실
모든 액션을 확인하고 어떤 순서로 실행되는지 이해하는 것은 중요하다. 모든 언어는 별도의 실행 방법을 가지고 있다. 자바스크립트 역시 마찬가지다.

##### ++와 +=는 사실 세 단계이다.
```ts
var temp = total // 읽기
temp = temp + 1; // 더하기(계산)
total = temp; // 쓰기(액션)
```

##### 인자는 함수를 부르기 전에 실행한다.
만약 함수에 인자를 전달하면서 실행한다면 인자는 함수에 전달되기 전에 실행된다. 이부분도 타임라인 다이어그램을 그릴 때 순서대로 표현되어야 한다.

```ts
console.log(total)
```
위 코드를 다이어그램으로 표현하면 다음과 같다.
```ts
var temp = total;
console.log(temp);
```

### 서로 다른 언어, 서로 다른 스레드 모델
자바스크립트는 단일 스레드, 비동기 모델을 사용한다. 하지만 모든 언어가 단일 스레드, 비동기 모델을 사용하는 것은 아니다.

#### 단일 스레드, 동기
기본적으로 멀티스레드를 지원하지 않는 언어도 있다. 예를 들어 PHP는 기본적으로 멀티스레드를 사용할 수 없다. 모든 것이 순서대로 실행되고, 입출력을 사용하면 끝날 때까지 기다려야한다. 하지만 이런 제약은 시스템이 단순하다는 장점이 있다. 스레드가 하나면 타임라인도 하나지만, 네트워크를 통한 API 호출같은 것은 다른 타임라인이 필요하다. 하지만 메모리를 공유하지 않기 떄문에 공유 자원을 많이 없앨 수 있다.

#### 단일 스레드, 비동기
자바스크립트는 스레드가 하나이다. 입출력 작업을 하려면 비동기 모델을 사용해야 한다. 입출력의 결과는 콜백으로 받을 수 있지만, 언제 끝날지 알 수 없기 때문에 다른 타임라인에 표현해야한다.

##### 멀티스레드
자바나 파이썬 같은 많은 언어가 멀티쓰레드를 지원한다. 멀티스레드는 실행순서를 보장하지 않기 때문에 프로그램하기 매우 어렵다.

#### 메시지 패싱 프로세스
엘릭서나 얼랭 같은 언어는 서로 다른 프로세스를 동시에 실행할 수 있는 스레드 모델을 지원한다. 프로세스는 서로 메모리를 공유하지 않고 메시지를 통신한다.

### 자바스크립트의 단일 스레드
자바스크립트의 스레드 모델은 타임라인이 자원을 공유하면서 생기는 문제를 줄여준다. 자바스크립트는 하나의 메인 스레드만 있어서 대부분의 액션을 하나의 박스로 표현할 수 있다.

자바 코드를 보자
```java
int x = 0;

public void addToX(int y) {
	x += y;
};
```
자바에서 두 스레드가 변수를 공유할 때 += 연산자는 실제로 세 단계로 실행된다.
1. 현재 값을 읽는다.
2. 그 값에 숫자를 더한다.
3. 새 값을 다시 저장한다.

두 스레드가 addTox를 동시에 실행한다면 실행 순서가 섞여 여러가지 결과가 나온다. 자바 스레드 모델은 이런 문제가 있다.

하지만 자바스크립트 스레드는 하나만 있다. 그래서 특별히 문제가 생기지 않는다. 자바스크립트에서 스레드를 사용한다면 같은 스레드를 계속 사용하는 것이다. 그리고 두 액션이 동시에 실행될 일도 없다.

하지만 비동기 콜백을 함께 사용한다면 문제가 생길 수 있다. 비동기 호출은 미래에 알 수 없는 시점에 런타임에 의해 실행된다.

### 자바스크립트의 비동기 큐
브라우저에서 동작하는 자바스크립트 엔진은 작업 큐라고 하는 큐를 가지고 있다. 작업 큐는 이벤트루프에 의해 처리된다. 이벤트 루프는 큐에서 작업 하나를 꺼내 실행하고 완료되면 다음 작업을 꺼내 실행하는 것을 무한히 반복한다. 이벤트 루프는 하나의 스레드에서 처리하기 때문에 두개의 작업이 동시에 실행될 수 없다.

### 재사용하기 더 좋은 코드로 만들기
비동기 호출을 사용한다면 출력을 콜백으로 바꿀 수 있다.
```ts
function calc_cart_total(cart, callback) {
	var total = 0;
	cost_ajax(cart, function(cost) {
	total += cost;
	shipping_ajax(cart, function(shipping) {
	callback(total);
	})
	})
}
function add_item_to_cart(name, price, quant) {
	cart = add_item(cart, name, price, quant);
	calc_cart_total(cart, update_total_dom);
}
```

### 정리
- 타임라인은 동시에 실행될 수 있는 순차적 액션을 말한다. 코드가 순서대로 실행되는지 동시에 실행되는지 알 수 있다.
- 현재 소프트웨어는 여러 타임라인에서 실행된다. 서로 다른 컴퓨터나 스레드, 프로세스, 비동기 호출과 같은 것이 있다면 새로운 타임라인을 추가한다.
- 서로 다른 타임라인에 있는 액션은 끼어들 수 있어서 여러 개의 실행 가능한  순서가 생긴다. 실행 가능한 순서가 많으면 코드가 항상 올바른 결과를 내는지 알기 어렵다.
- 자원을 공유하는 부분은 버그가 발생하기 쉽다.